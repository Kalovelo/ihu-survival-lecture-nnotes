# IP - Πρωτόκολλο Διαδικτύου


## Μορφή Δεδομενόγραμματος IPv4


|    Μορφή Δεδομενόγραμματος IPv4    |
| :--------------------------------: |
| <img src="./images/datagram.png"/> |

1. **Αριθμός Έκδοσης (4-bit)**: Έκδοση πρωτοκόλλου IP. Εξετάζοντας αυτό το πεδίο, **ο δρομολογητής** μπορεί να καθορίσει **πως να ερμηνεύσει** το υπόλοιπο δεδομενόγραμμα IP. 
   - Διαφορετικές εκδόσεις = Διαφορετικές μορές δεδομενογράμματος

2. **Μήκος Κεφαλίδας (4-bit)**: Καθορίζουν **που ακριβώς αρχίζει το ωφέλιμο φορτίο** μέσα στο δεδομενόγραμμα. Ο λόγος που συμβαίνει αυτό είναι γιατί ένα δεδομενόγραμμα μπορεί να περιέχει ένα **μεταβλητό αριθμό** επιλογών. Επειδή τα περισσότερα δεδομενογράμματα δεν περιέχουν επιλογές, το τυπικό μέγεθος κεφαλίδας είναι **20 byte**.

3. **Τύπος Υπηρεσίας (1-bit)**: Καθορίζει τον τύπο δεδομένων (π.χ. πραγματικού χρόνου). Είναι θέμα πολιτικής και καθορίζεται από τον διαχειριστή δρομολογητή.

4. **Μήκος δεδομενογράμματος (16-byte)**: Συνολικό μήκος (κεφαλίδα + δεδομένα) μετρούμενο σε byte. Το μέγιστο μέγεθος δεδομενογράμματος είναι 2^16 = 65.535 byte. 

5. **Ταυτότητα, σημαίες, μετατόπιση κατάτμησης**: σχετίζονται με την κατάτμηση IP.

6. **Διάρκεια ζωής**: Διασφαλίζει ότι τα δεδομενογράμματα δεν κυκλοφορούν για πάντα μέσα στο δίκτυο. Το πεδίο αυτό **μειώνεται κατά 1** κάθε φορά που γίνεται **επεξεργασία του δεδομενογράμματος** από ένα δρομολογητή.

7. **Πρωτόκολλο**: Χρησιμοποιείται μόνο από τον προορισμό. Δηλώνει το **πρωτόκολλο επιπέδου μεταφοράς**. Είναι η κόλλα που συνδέει τα επίπεδα δικτύου και μεταφοράς.
    - τιμή 6: TCP
    - τιμή 17: UDP

8. **Άθροισμα ελέγχου κεφαλίδας**: Ανιχνεύει σφάλματα bit. Υπολογίζοντας λαμβάνοντας κάθε 2 byte μέσα στην κεφαλίδα ως έναν αριθμό. Εν τέλει, αθροίζονται. Ένας δρομολογητής υπολογίζει το άθροισμα ελέγχου κεφαλίδας για κάθε ληφθέν δεδομενόγραμμα.Έπειτα ανιχνεύει μια συνθήκη σφάλματος αν το **άθροισμα ελέγχου μέσα στην κεφαλίδα** είναι διαφορετικό από το **υπολογισμένο άθροισμα ελέγχου**
   - **Κάθε φορά** που ένα δεδομενόγραμμα **φθάνει σε ένα δρομολογητή**, το άθροισμα ελέγχου πρέπει να **ξανά υπολογιστεί και να αποθηκευτεί** επειδή το πεδίο TTL (όπως και άλλα πεδία) πιθανότατα να άλλαξε.
   - Έλεγχος σφάλματος γίνεται στο IP αλλά και στο επίπεδο μεταφοράς γιατί το IP ανιχνεύει σφάλματα **μόνο στην κεφαλίδα IP** ενώ το άθροισμα ελέγχου TCP/UDP **υπολογίζει για όλο το τμήμα** TCP/UDP.
9. **Διευθύνσεις IP προέλευσης και προορισμού**: Χρήση στην διευθυνσιοδότηση.
10. **Επιλογές**: Επιτρέπουν σε μια κεφαλίδα IP **να επεκταθεί**. Χρησιμοποιούνται **σπάνια**: Δεν μπορεί εκ των προτέρων να υπολογίσει κάποιος **που θα αρχίσει το πεδίο δεδομένων**.
11. **Δεδομένα (ωφέλιμο φορτίο)**: Τις περισσότερες φορές το πεδίο δεδομένων περιλαμβάνει το τμήμα επιπέδου μεταφοράς (TCP/UDP).

## Κατάτμηση Δεδομενογράμματος IPv4

Όλα τα πρωτόκολλα επιπέδου ζεύξης μεταφέρουν πακέτα **ίδιου μεγέθους**.

❗Η μέγιστη ποσότητα δεδομένων που μπορέι να μεταφέρει ένα πακέτο επιπέδου ζεύξης καλείται **μέγιστη μονάδα μεταφορα (Maximum Transfer Unit,MTU)**.

Επειδή κάθε δεδομενόγραμμα ενθυλακώνεται σε πλαίσιο επιπέδου ζεύξης για μεταφορά μεταξύ δρομολογητών, η MTU τοποθετεί **ένα αυστηρό άνω όριο** στο μήκος δεδομενογράμματος IP. 

Εδώ υπάρχει ένα προβλημα με τις ζεύξεις που χρησιμοποιούν διαφορετικά πρωτόκολλα επιπέδου ζεύξης, άρα **διαφορετική MTU**.

Η λύση στο παραπάνω πρόβλημα είναι η **κατάτμηση του ωφέλιμου φορτίου** δεδομενογράμματος σε 2+ **μικρότερα δεδομενογράμματα** και η ενθυλάκωση τους σε 2+ **διαφορετικά πλαίσια επιπέδου ζεύξης**.

❗ Αυτά τα μικρότερα τεμάχια δεδομενογραμμάτων, ονομάζονται **τεμάχια (fragments)**. Η ανασύνθεση τους γίνεται στα **τερματικά συστήματα** και όχι στους δρομολογητές.

Όταν ένας υπολογιστής προορισμού δέχεται μια σειρά δεδομενογραμμάτων από την ίδια πηγή, πρέπει να καθορίσει αν κάποια δεδομενογράμματα είναι τεμάχια. Αυτό αναγνωρίζεται μέσω **πεδίων ταυτότητας,τοποθέτησης και μετατόπισης κατάτμησης** στο δεδομενόγραμμα. Όταν δημιουργείται ένα δεδομενόγραμμα, ο αποστολέας το **σφραγίζει με έναν αριθμό ταυτότητας**, όπως κάνει με τις διευθύνσεις αποστολής-προορισμού.  
Ο αποστολέας **προσαυξάνει τον αριθμό ταυτότητας κατά 1, για κάθε δεδομενόγραμμα.**  
Κάθε φορά που πρέπει να κομματιαστεί ένα δεδομενόγραμμα, ο αποστολέας σφραγίζει τα τεμάχια με τις διευθύνσεις αποστολής-προορισμού και τον **αριθμό ταυτότητας του αρχικού δεδομενογράμματος.**  

Για να είναι σίγουρος ο αποστολέας ότι έλαβε όλα τα τεμάχια ενός δεδομενογράμματος, **το τελευταίο τεμάχιο έχει bit-σημαία με τιμή 0** ενώ όλα τα υπόλοιπα έχουν τεμάχια με **bit-σημαία με τιμή 1**. 

Για να υπάρξει σωστή σειρά, το πεδίο **μετατόπισης** καθορίζει που μπαίνει το τεμάχιο μέσα στο αρχικό δεδοενόγραμμα IP.