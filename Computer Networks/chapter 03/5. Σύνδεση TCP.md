# Σύνδεση TCP

- Συνδεσμικό πρωτόκολλο
    - Πριν γίνει μεταφορά δεδομένων, πρέπει να υπάρξει μια **αρχική χειραψία** 
- Εκτελείται **μόνο τα τερματικά συστήματα**
  - **Οι δρομολογητές** και οι μεταγωγείς επιπέδου ζεύξης **δεν αναγνωρίζουν το TCP**, δέχονται μόνο δεδομενογράμματα
- Παρέχει **αμφίδρομη υπηρεσία**
  - Μπορούν να σταλούν και να ληφθούν δεδομένα **ταυτόχρονα**
- Είναι πάντα **από-σημείο-σε-σημείο (point-to-point)** 
  - Πάντα υπάρχει 1 αποστολέας και 1 δέκτης

## Σύνδεση

Η τρίδρωμη χειραψία 
1. Ο πελάτης στέλνει πρώτα ένα ειδικό τμήμα TCP
   - Δεν περο MSS καθορίιέχει ωφέλιμο φορτίο 
2. Ο server αποκρίνεται μ'ένα δεύτερο ειδικό πεδίο TCP
   - Δεν περιέχει ωφέλιμο φορτίο
3. Ο πελάτης ξανά αποκρίνεται με ένα ειδικό τμήμα.

Αφού εγκαθιδρυθεί η σύνδεση TCP, οι διεργασίες εφαρμογής μπορούν να στείλουν δεδομένα μεταξύ τους.

1. Η διεργασία πελάτη περνά ένα ρεύμα δεδομένων μέσω της socket
2. Έπειτα, βρίσκονται τώρα στα χέρια του TCP που τα κατευθύνει στον **ενταμιευτή αποστολής (send buffer)**
   - Ο ενταμιευτής αποστολής δεσμεύεται από την αρχική τρίδρομη χειραψία 
   - Με το χρόνο, το TCP θα δέχεται δεδομένα και θα τα μεταβιβάζει στον ενταμιευτή.
   -  Η μέγιστη ποσότητα δεδομένων που μπορεί να συλλεχθεί και να τοποθετηθεί μέσα σε ένα τμήμα περιορίζεται από το **μέγιστο μέγεθος τμήματος (maxium segment size,MSS)** .
      - Το MSS καθορίζεται βρίσκοντας πρώτα το **μήκος του μεγαλύτερου πλαισίου επίπέδου ζεύξης** που μπορεί να σταλεί από τον τοποικό υπολογιστή αποστολής το οποίο καλείται **μέγιστη μονάδα μετάδοσης (maximum transmission unit,MTU)**
      - Το MSS καθορίζεται για να είναι σίγουρο ότι ένα **τμήμα TCP**  + **μήκος κεφαλίδας** (40 byte) **θα χωράει σε ένα πλαίσιο επιπέδου ζεύξης**
      - Το MSS είναι η **μέγιστη ποσότητα δεδομένν επιπέδου εφαρμογής μέσα στο τμήμα**, όχι το μέγιστο μεεθος τμήματος TCP (που περιλαμβάνει κεφαλίδες)
   - Το TCP βάζει σε κάθε τμήμα δεδομένων μια **κεφαλίδα TCP** για το σχηματισμό του πλαισίου TCP 
3. Ο Ενταμιευτής θα τα μεταβιβάζει τέλος, στο επίπεδο δικτύου.
4. Ότνα ληφθεί ένα τμήμα TCP στο άλλο άκρο
   - Τα δεδομένα τοποθετουται στον **ενταμιευτή λήψης**
    - Η εφαρμογή θα διαβάσει το ρεύμα δεδομένων από τον ενταμιευτή

## Δομή τμήματος TCP 

> Όταν το TCP στέλνει ένα μεγάλο αρχείο όπως μια εικόνα, τότε το **διαιρεί σε κομμάτια μεγέθους MSS**

Πεδία Τμήματος TCP
- Κεφαλίδα
  1. Άθροισμα Ελέγχου
       - Έλεγχος Σφαλμάτων
  2. Αριθμός Θυρών προέλευσης και προορισμού
       - Πολύπλεξη/Αποπολύπλεξη
  3. Αριθμός Ακολουθίας - 32bit
       - Αξιόπιστη μεταφορά δεδομένων   
  4. Αριθμός Επιβεβαίωσης - 32bit
       - Αξιόπιστη μεταφορά δεδομένων   
  5. Παράθυρο Λήψης - 16bit
       - Έλεγχος ροής. Δηλώνει τον αριθμό byte που προτίθεται να δεχθεί ο παραλήπτης.
  6. Πεδίο μήκους κεφαλίδας - 4bit
       - καθορίζει το μήκος κεφαλίδας TCP σε λέξεις των 32bit.
       - Η κεφαλίδα μπορεί να έχει μεταβλητό μήκος. 
  7. Πεδίο επιλογών (προαιρετικό)
     - Χρήση για διαπραγμάτευση 
       - για το MSS  
       - για κλίμακα σε δίκτυα ταχυτήτων
       - για χρονοσφράγιση
  8. Το πεδίο σημαίας - 6bit 
       - ACK - Επιτυχής λήψη
       - SYN - εγκαθίδρυση σύνδεσης
       - FIN - διακοπή σύνδεσης  
       - CWR & ECE - ειδοποίηση συμφόρησης
       - PSH - Ένδειξη μεταφοράς δεδομένων στο ανώτερο επίπεδο
       - URG - Δεδομένα σημειωμένα ως επείγοντα 
         - Δηλώνεται με ένα πεδίο δείκτη επειγόντων δεδομένων
- Δεδομένα

<img src="./images/tcp_segment.png">

### Αριθμοί ακολουθίας & Επιβεβαίωσης

> Μπορεί να μπερδέψει, για αυτό σελίδα 237 - 240 για παραδείγματα.


- Το TCP θεωρεί τα δεδομένα ως ένα αδόμητο αλλά διατεταγμένο ρεύμα bytes.
- Οι αριθμοί ακολουθίας **αναφέρονται στο ρεύμα μεταδιδομένων byte** και όχι στη σειρά μεταδιδομένων τμημάτων.
  - Ό αριθμός ακολουθίας για ένα τμήμα είναι **ο αύξων αριθμός του πρώτου byte μέσα στο τμήμα**
- Ο αριθμός επιβεβαίωσης που θέτει ο  Α στο τμήμα του είναι **ο αριθμός ακολουθίας του επόμενου byte** που περιμένει ο Α από τον Β
  - Επειδή το TCP επιβεβαιώνει **μόνο byte μέχρι το πρώτο ελλειπόν byte στο ρεύμα**, το TCP λέγεται ότι παρέχει **συσσωρευτικές επιβεβαιώσεις**
  - Δεν υπάρχουν κανόνες για τα εκτός σειράς πακέτα
    1. είτε απορρίπτονται
    2. είτε ενταμιεύονται 

### Εκτίμηση και λήξη χρόνου διαδρομής μετ'επιστροφής

- Το TCP χρησιμοποιεί ένα δείγμα RTT 
  - συμβολίζεται ως sampleRTT για ένα τμήμα
  - είναι ο **χρόνος από τη στιγμή που στέλνεται** το τμήμα στο IP **μέχρι να ληφθεί επιβεβαίωση**
- Αντί να μετράται ένα sampleRTT για κάθε μεταδιδόμενο τμήμα, οι περισσότερες TCP υλοποιήσεις παίρνουν μια μέτρηση sampleRTT τη φορά.
  - Το sampleRTT, σε κάθε χρονικό σημείο, εκτιμάται για 1 μεταδοθέν επιβεβαιωμένο τμήμα.
  - 1 τιμή sampleRTT κάθε RTT
  - **Τα επαναμεταδοθέντα** sampleRTT δεν υπολογίζονται.
- Επειδή τα sampleRTT δεν είναι ίσα, εκτιμάται **μια μέση τιμή** SampleRTT. η τιμή λέγεται **estimatedRTT**
  - Η τιμή βασίζεται περισσότερο στα πιο πρόσφατα sampleRTT

### Διαχείριση λήξης χρόνου Αναμετάδοσης

- Το διάστημα θα πρέπει να είναι >= estimatedRTT
   - Αν είναι πολύ μεγαλύτερο
     - Μεγάλη καθυστέρηση επαναμετάδοσης 
   - Για αυτό θέτουμε
     - Λήξη χρόνου = estimatedRTT + περιθώριο
- **Κάθε φορά** που συμβαίνει λήξη χρόνου
  - η τιμή της λήξης χρόνου **διπλασιάζεται**
  - Μόλις γίνει σωστή μετάδοση, τότε το λήξη χρόνου υπολογίζεται ξανά από τον τύπο. 

## Αξιόπιστη Μεταφορά Δεδομένων

Γνωρίζουμε ότι στο IP τα δεδομενογράμματα μπορούν να υπερχειλίζουν ενταμιευτές δρομολογητών.

- Στο TCP, χρησιμοποιείται 1 μόνο χρονομετρητής επαναμετάδοσης
- Υπάρχουν 3 σημαντικά συμβάντα
  1. Λήψη δεδομένων από εφαρμογή
     - Ενθυλάκωση δεδομένων σε τμήμα
     - Αριθμός ακολουθίας = αριθμό πρώτου byte μέσα στο τμήμα
     - Πέρασμα στο IP  
     - Αν δεν τρέχει χρονομετρητής, αρχίζει τώρα
  2. Λήξη χρόνου    
     - Επαναμετάδοση
     - Επανεκκίνηση χρονομετρητή
  3. Άφιξη τμήματος επιβεβαίωσης y  
     - Το TCP έχει μια μεταβλητή **SendBase** που είναι **ο αριθμός ακολουθίας του παλαιότερου μη επιβεβαιωθέντος byte**
       - sendbase-1 είναι ο αριθμός ακολουθίας του τελευταίου επιβεβαιωθέντος byte
     - Η sendbase συγκρίνεται με την y.
       - αν y>sendbase, τότε το ACK επιβεβαιώνει 1+ περισσότερα προηγουμένως ανεπιβεβαίωντα τμήματα.

> Παραδείγματα σελίδες 246-247.

### Διπλασιασμός διαστήματος λήξης χρόνου

Κάθε φορά που το TCP επαναμεταδίδει, θέτει το επόμενο διάστημα λήξης χρόνου το διπλάσιο. **Τα διαστήματα αυξάνονται εκθετικά μετά από κάθε επαναμετάδοση**. Όταν ο χρονομετρητής εκκινήσει είτε από νέα παραλαβή δεδομένων από το επίπεδο εφαρμογής προς αποστολή ή ληφθεί ack, τότε το διάστημα λήξης χρόνου βρίσκεται από τις πιο πρόσφατες τιμές estimatedRTT και περιθώριο.

### Ταχεία Επαναμετάδοση 

**Το πρόβλημα**: Οι επαναμεταδόσεις προκαλούν αύξηση της περιόδου λήξης χρόνου. Ο αποστολέας μπορεί να ανιχνεύσει την απώλεια πακέτων πριν τη λήξη χρόνου, μέσω διπλότυπων ACK. 

**Ένα διπλότυπο ACK** είναι ένα ACK που κάνει εκ νέου επιβεβαίωση για ένα τμήμα που έχει ήδη επιβεβαιωθεί στον αποστολέα.

Όταν ο παραλήπτης λαμβάνει ένα τμήμα με έναν αριθμό ακολουθίας μεγαλύτερο από τον επόμενο αναμενόμενο αριθμό ακολουθίας με σωστή σειρά, τότε υπάρχει ένα **χάσμα** μέσα στο ρεύμα δεδομένων - ένα ελλείπον τμήμα.

**Το TCP δεν χρησιμοποιεί αρνητικές επιβεβαιώσειες NAΚ** με αποτέλεσμα ο παραλήπτης να μην μπορεί να στείλει ρητή αρνητική επιβεβαίωση. Για αυτό παράγει ένα διπλότυπο ACK για **το τελευταίο byte που λήφθηκε με τη σωστή σειρά.**

Ο αποστολέας στέλνει ένα μεγάλο αριθμό τμημάτων το ένα πίσω από το άλλο. Για αυτό υπάρχει πιθανότατα να δεχθεί πολλά μαζεμένα διπλότυπα ACK. Αν δεχθεί **3 διπλύτυπα ACK για τα ίδια δεδομένα**, τότε το εκλαμβάνει ως ένδειξη πως **το τμήμα που ακολουθεί εκείνο το τμήμα για το οποίο έχει γίνει επιβεβαίωση 3 φορες, έχει χαθεί**. Τότε ο αποστολέας κάνει μια **ταχεία επαναμετάδοση(fast retransmit)**, επαναμεταδίδοντας το ελλειπόν τμήμα **πριν λήξει ο χρονομετρητής** αυτού του τμήματος.

> Εικόνα σελίδα 251


## Έλεγχος Ροής

Ο έλεγχος ροής είναι μια υπηρεσία ταιριάσματος ταχυτήτων - ταιριάζει το ρυθμό με τον οποίο ο αποστολέας στέλνει με τον ρυθμό τον οποίο διαβάζει η εφαρμογή λήψης.

Για να το κάνει αυτό, το TCP χρησιμοποιεί μια μεταβλητή που λέγεται **παράθυρο λήψης (receive window)**. Το παράθυρο λήψης χρησιμοποιείται για να ενημερώνει τον αποστολέα πόσο περίπου διαθέσιμος χώρος υπάρχει στον **ενταμιευτή παραλήπτη** 

Σε ένα σενάριο, ο Α στέλνει στο Β ένα μεγάλο αρχείο.

**Στην πλευρά του παραλήπτη Β**  
 ο Β δεσμεύει έναν ενταμιευτή λήψης με μέγεθος rcvBuffer. Υπάρχουν οι μεταβλήτες:

- LastByteRead: **αριθμός του τελευταίου byte** στο ρεύμα δεδομένων **που διαβάστηκε από την εφαρμογή** από τον ενταμιευτή στον Β
- LastByteRcv: **αριθμός του τελευταίου byte** στο ρεύμα δεδομένων **που έφθασε από το δίκτυο** και έχιε τοποθετηθεί στον ενταμιευτή λήψης στο Β

Το παράθυρο λήψης υπολογίζεται ως εξής:

rwnd = RcvBuffer - (LastByteRead - LastByteRcv)

Ο Β λέει στον Α πόσο κενό χώρο έχει μέσα στονsendbase ενταμιευτή τοποθετώντας **την τρέχουσα τιμή rwnd** στο **πεδίο παραθύρου λήψης κάθε τμήματος** που στέλνει στον Α.

**Στην πλευρά του αποστολέα Α**  
Ο Α έχει τις μεταβλητές
- LastByteSent
- LastByteAcked  

με προφανείς σημασίες. **Η διαφορά**  
LastByteSent - LastByteAcked είναι **η ποσότητα των ανεπιβεβαιώτων δεδομένων** που έχει στείλει ο Α μέσα στη σύνδεση.

Για να σιγορευτεί ο Α ότι δεν γίνεται υπερχείλιση του ενταμιευτή λήψης Β, ελέγχει συνεχώς τη σχέση

LastByteSent - LastByteAcked <= rwnd

## Διαχείριση σύνδεσης tcp

**Εγκαθίδρυση σύνδεσης**
1. Αποστολή ειδικού τμήματος tcp στο tcp του server.
   - Δεν περιλαμβάνει δεδομένα επιπέδου εφαρμογής. 
   - το SYN bit τίθεται 1
   - Επιλογή αρχικού αριθμού ακολουθίας client_isn -> εισαγωγή του στο τμήμα
2. Ο server παραλαμβάνει το τμήμα
   - Δέσμευση ενταμιευτών & μεταβλητών
   - Αποστολή τμήματος αποδοχής σύνδεσης
     - Δεν περιέχει δεδομένα εφαρμογής
     - το SYN bit τίθεται 1
     - Το **πεδίο επιβεβαίωσης** κεφαλίδας τίθεται σε **client_isn+1**
     - Επιλογή αριθμού ακολουθίας server_isn
     - Είναι γνωστό και ως **SYNACK**
3. Πελάτης λαμβάνει SYNACK
   - Δέσμευση ενταμιευτών & μεταβλητών
   - Αποστολή τμήματος ACK για την αποδοχή σύνδεσης του σέρβερ
     - Το **πεδίο επιβεβαίωσης** κεφαλίδας τίθεται σε **server_isn+1**
     - Το SYN bit τίθεται 0


**Τερματισμός Σύνδεσης**

- Όταν μια σύνδεση τερματίζεται, οι πόροι (Ενταμιευτές & Μεταβλητές) απελευθερώνονται.
- Η αίτηση τερματισμού γίνεται με το FIN bit = 1
- Η άλλη άκρη απαντάει και αυτή με FIN bit = 1
- Η αρχική άκρη το επιβεβαιώνει
- Και οι 2 άκρες απελευθερώνουν τους πόρους

### Μετάβαση Καταστάσεων

Πελάτης
- Αρχίζει στην κατάσταση CLOSED
- Εκκινεί μια σύνδεση TCP
- Αποστολή SYN στο σέρβερ
- Εισαγωγή στην κατάσταση SYN_SENT
- Αναμονή για απάντηση
- Άφιξη απάντησης, εισαγωγή στην κατάσταση ESTABLISHED
- Στην ESTABLISHED, ο πελάτης μπορεί να στέλνει/δέχεται τμήματα με ωφέλιμο φορτίο
- Όταν θελήσει να τερματίσει, στέλνει τμήμα TCP με FIN bit = 1
- Εισαγωγή στην κατάσταση FIN_WAIT_1
- Αναμονή επιβεβαίωσης
- Όταν το λάβει, εισαγωγή στην κατάσταση FIN_WAIT_2
- Αναμονή για τμήμα με FIN bit = 1 
- Αποστολή επιβεβαίωσης λήψης FIN
- Εισαγωγή στην κατάσταση TIME_WAIT
  - Η κατάσταση αυτή επιτρέπει στον πελάτη να στείλει εκ νέου την τελική επιβεβαίωσης σε περίπτωση που χαθεί το ACK
  - ο χρόνος είναι περιπου 30sec

Server
- Αρχίσει στην κατάσταση CLOSED
- Δημιουργία Socket ακρόασης
- LISTEN
- Λήψη SYN, απάντηση με SYN & αριθμό ακολουθίας
- SYN_RCVD
- Λήψη ACK, Αναμονή
- ESTABLISHED
- Όταν ληφθεί FIN, αποστολή ACK
- CLOSE_WAIT
- Αποστολή FIN
- LAST_ACK
- Λήψη ACK, απελευθέρωση πόρων.

> Όταν ένας σέρβερ λάβει ένα τμήμα TCP με αριθμό θύρας που δεν χρησιμοποιεί, τότε στέλνει ένα τμήμα TCP με το RST (reset) bit = 1.