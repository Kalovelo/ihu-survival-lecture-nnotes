# Σύνδεση TCP

- Συνδεσμικό πρωτόκολλο
    - Πριν γίνει μεταφορά δεδομένων, πρέπει να υπάρξει μια **αρχική χειραψία** 
- Εκτελείται **μόνο τα τερματικά συστήματα**
  - **Οι δρομολογητές** και οι μεταγωγείς επιπέδου ζεύξης **δεν αναγνωρίζουν το TCP**, δέχονται μόνο δεδομενογράμματα
- Παρέχει **αμφίδρομη υπηρεσία**
  - Μπορούν να σταλούν και να ληφθούν δεδομένα **ταυτόχρονα**
- Είναι πάντα **από-σημείο-σε-σημείο (point-to-point)** 
  - Πάντα υπάρχει 1 αποστολέας και 1 δέκτης

## Σύνδεση

Η τρίδρωμη χειραψία 
1. Ο πελάτης στέλνει πρώτα ένα ειδικό τμήμα TCP
   - Δεν περο MSS καθορίιέχει ωφέλιμο φορτίο 
2. Ο server αποκρίνεται μ'ένα δεύτερο ειδικό πεδίο TCP
   - Δεν περιέχει ωφέλιμο φορτίο
3. Ο πελάτης ξανά αποκρίνεται με ένα ειδικό τμήμα.

Αφού εγκαθιδρυθεί η σύνδεση TCP, οι διεργασίες εφαρμογής μπορούν να στείλουν δεδομένα μεταξύ τους.

1. Η διεργασία πελάτη περνά ένα ρεύμα δεδομένων μέσω της socket
2. Έπειτα, βρίσκονται τώρα στα χέρια του TCP που τα κατευθύνει στον **ενταμιευτή αποστολής (send buffer)**
   - Ο ενταμιευτής αποστολής δεσμεύεται από την αρχική τρίδρομη χειραψία 
   - Με το χρόνο, το TCP θα δέχεται δεδομένα και θα τα μεταβιβάζει στον ενταμιευτή.
   -  Η μέγιστη ποσότητα δεδομένων που μπορεί να συλλεχθεί και να τοποθετηθεί μέσα σε ένα τμήμα περιορίζεται από το **μέγιστο μέγεθος τμήματος (maxium segment size,MSS)** .
      - Το MSS καθορίζεται βρίσκοντας πρώτα το **μήκος του μεγαλύτερου πλαισίου επίπέδου ζεύξης** που μπορεί να σταλεί από τον τοποικό υπολογιστή αποστολής το οποίο καλείται **μέγιστη μονάδα μετάδοσης (maximum transmission unit,MTU)**
      - Το MSS καθορίζεται για να είναι σίγουρο ότι ένα **τμήμα TCP**  + **μήκος κεφαλίδας** (40 byte) **θα χωράει σε ένα πλαίσιο επιπέδου ζεύξης**
      - Το MSS είναι η **μέγιστη ποσότητα δεδομένν επιπέδου εφαρμογής μέσα στο τμήμα**, όχι το μέγιστο μεεθος τμήματος TCP (που περιλαμβάνει κεφαλίδες)
   - Το TCP βάζει σε κάθε τμήμα δεδομένων μια **κεφαλίδα TCP** για το σχηματισμό του πλαισίου TCP 
3. Ο Ενταμιευτής θα τα μεταβιβάζει τέλος, στο επίπεδο δικτύου.
4. Ότνα ληφθεί ένα τμήμα TCP στο άλλο άκρο
   - Τα δεδομένα τοποθετουται στον **ενταμιευτή λήψης**
    - Η εφαρμογή θα διαβάσει το ρεύμα δεδομένων από τον ενταμιευτή

## Δομή τμήματος TCP 

> Όταν το TCP στέλνει ένα μεγάλο αρχείο όπως μια εικόνα, τότε το **διαιρεί σε κομμάτια μεγέθους MSS**

Πεδία Τμήματος TCP
- Κεφαλίδα
  1. Άθροισμα Ελέγχου
       - Έλεγχος Σφαλμάτων
  2. Αριθμός Θυρών προέλευσης και προορισμού
       - Πολύπλεξη/Αποπολύπλεξη
  3. Αριθμός Ακολουθίας - 32bit
       - Αξιόπιστη μεταφορά δεδομένων   
  4. Αριθμός Επιβεβαίωσης - 32bit
       - Αξιόπιστη μεταφορά δεδομένων   
  5. Παράθυρο Λήψης - 16bit
       - Έλεγχος ροής. Δηλώνει τον αριθμό byte που προτίθεται να δεχθεί ο παραλήπτης.
  6. Πεδίο μήκους κεφαλίδας - 4bit
       - καθορίζει το μήκος κεφαλίδας TCP σε λέξεις των 32bit.
       - Η κεφαλίδα μπορεί να έχει μεταβλητό μήκος. 
  7. Πεδίο επιλογών (προαιρετικό)
     - Χρήση για διαπραγμάτευση 
       - για το MSS  
       - για κλίμακα σε δίκτυα ταχυτήτων
       - για χρονοσφράγιση
  8. Το πεδίο σημαίας - 6bit 
       - ACK - Επιτυχής λήψη
       - SYN - εγκαθίδρυση σύνδεσης
       - FIN - διακοπή σύνδεσης  
       - CWR & ECE - ειδοποίηση συμφόρησης
       - PSH - Ένδειξη μεταφοράς δεδομένων στο ανώτερο επίπεδο
       - URG - Δεδομένα σημειωμένα ως επείγοντα 
         - Δηλώνεται με ένα πεδίο δείκτη επειγόντων δεδομένων
- Δεδομένα

<img src="./images/tcp_segment.png">

### Αριθμοί ακολουθίας & Επιβεβαίωσης

> Μπορεί να μπερδέψει, για αυτό σελίδα 237 - 240 για παραδείγματα.


- Το TCP θεωρεί τα δεδομένα ως ένα αδόμητο αλλά διατεταγμένο ρεύμα bytes.
- Οι αριθμοί ακολουθίας **αναφέρονται στο ρεύμα μεταδιδομένων byte** και όχι στη σειρά μεταδιδομένων τμημάτων.
  - Ό αριθμός ακολουθίας για ένα τμήμα είναι **ο αύξων αριθμός του πρώτου byte μέσα στο τμήμα**
- Ο αριθμός επιβεβαίωσης που θέτει ο  Α στο τμήμα του είναι **ο αριθμός ακολουθίας του επόμενου byte** που περιμένει ο Α από τον Β
  - Επειδή το TCP επιβεβαιώνει **μόνο byte μέχρι το πρώτο ελλειπόν byte στο ρεύμα**, το TCP λέγεται ότι παρέχει **συσσωρευτικές επιβεβαιώσεις**
  - Δεν υπάρχουν κανόνες για τα εκτός σειράς πακέτα
    1. είτε απορρίπτονται
    2. είτε ενταμιεύονται 