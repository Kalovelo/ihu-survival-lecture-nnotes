# Έλεγχος Συμφόρησης TCP

Η προσέγγιση που ακολουθείται στο TCP είναι **να περιορίζει κάθε αποστολέας τον αριθμό με τον οποίο στέλνει κίνηση** μέσα στη σύνδεση του, ως μια συνάρτηση αντιληπτής συμφόρησης δικτύου.

Αν ο αποστολέας αντιληφθεί μικρή συμφόρηση στο δίκτυο, τότε μειώνεται την κίνηση του.
Αν ο αποστολέας αντιληφθεί μεγάλη συμφόρηση στο δίκτυο, τότε αυξάνει την κίνηση του.

**Παράθυρο Συμφόρησης (congestion window, cwnd)** - Θέτει περιορισμό στον ρυθμό με τον οποίο ο αποστολέας μπορεί να στείλει κίνηση στο δίκτυο. Συγκεκριμένα, **η ποσοότητα μη επιβεβαιωθέντων** μηνυμάτων δεν μπορεί να ξεπερνά το:  

LastByteSent - Last Byte Acked <= min(cwnd,rwnd)

> Σενάρια σελίδες 270-271

- Όταν υπάρχει συμφόρηση τότε ένας ή περισσότεροι ενταμιευτές δρομολογητών κατά μήκος της διαδρομής υπερχειλίζουν προκαλώντας την απόρριψη ενός δεδομενογράμματος
- Το TCP λέγεται αυτο-ρυθμιζόμενο γιατί χρησιμοποιεί επιβεβαιώσεις για να εκκινήσει την αύξηση του μέσα στο μέγεθος cwnd
- Ο αποστολέας μπορεί να ρυθμίζει το ρυθμό με τον οποίο στέλνει δεδομένα προσαρμόζοντας την τιμή cwnd

Αρχές ελέγχου συμφόρησης στο TCP

1. Ένα απολεσθέν τμήμα υπονοεί **συμφόρηση** και πρέπει να μειωθεί ο ρυθμός αποστολής **όταν χαθεί ένα τμήμα**.
2. Τα μηνύματα επιβεβαίωσης επιτρέπουν στον αποστολέα **να αυξήσει τον ρυθμό αποστολής**.
3. **Βολιδοσκόπηση εύρους ζώνης**. Όταν συμβεί ένα συμβάν απώλειας, ο ρυθμός μετάδοσης μειώνεται. Μέχρι τότε, ο αποστολέας αυξάνει το ρυθμό μετάδοσης για να βολιδοσκοπήσει το ρυθμό στον οποίο αρχίζει η συμφόρηση. Οπισθοχωρεί σε περίπτωση συμφώρησης και έπειτα ξανά βολιδοσκοπεί για να δει αν άλλαξε η συμφόρηση.

## Αλγόριθμος Ελέγχου Συμφόρησης

3 στάδια
1. Αργή Εκκίνηση
2. Αποφυγή Συμφόρησης
3. Ταχεία Ανάκαμψη

### Αργή Εκκίνηση

Όταν ξεκινά μια σύνδεση TCP, το cwnd παίρνει την τιμή **1 MSS**. **Κάθε φορά που επιβεβαιώνεται** ένα τμήμα, τότε αυξάνεται το cwnd κατά 1 MSS. Αυτό έχει ως αποτέλεσμα να **διπλασιάζεται** το cwnd σε κάθε επιτυχές RTT.  
Αν υπάρξει **λήξη χρόνου**, τότε το cwnd = 1 και αρχίζει τη διεργασία αργής εκκίνησης **εκ νέου**.Επίσης, θέτει μια νέα μεταβλητή **ssthresh** . Η ssthresh είναι το **κατώφλι της αργής εκκίνησης**. Η τιμή που θέτεται **είναι cwnd/2**.  
Ο άλλος τρόπος ανίχνευσης συμφόρησης, είναι όταν μετά από αυξήσεις του cwnd, το cwnd φτάσει την **τιμή του ssthresh**( είναι επικίνδυνος η εκθετική αύξηση λόγω διπλασιασμού σε κάθε RTT). Όταν συμβεί αυτό, τότε εισερχόμαστε στην κατάσταση Αποφυγή Συμφόρησης.  
Τελευταίος τρόπος, αν **ανιχνευτούν 3 διπλότυπα ACK**, τότε εκτελείται μια **ταχεία αναμετάδοση** και εισέρχεται στην ταχεία ανάκαμψη.

### Αποφυγή Συμφόρησης 

Όταν γίνει εισαγωγή σε αυτή την κατάσταση, τότε cwnd >= ssthresh. Τότε, αντι να διπλασιάζεται το cwnd σε κάθε RTT, **αυξάνεται κατά 1 MSS σε κάθε RTT**. Αυτό συνεχίζεται μέχρι να συμβεί μια λήξη χρόνου. Τότε, το ssthresh θα πάρει μια νέα τιμή και έτσι θα γίνει εισαγωγή στην αργή εκκίνηση.  
Σε περίπτωση τριάδας διπλότυπου ACK, τότε το TCP **μειώνει στο μισό το cwnd** (προσθέτοντας 3 MSS) και κάνει το ssthresh να είναι cwnd/2 όταν λήφθηκε η τριάδα. Έπειτα εισέρχεται στην ταχεία ανάκαμψη.

### Ταχεία ανάκαμψη

Εδώ το cwnd αυξάνεται κατά **1 MSS** για κάθε **διπλότυπο** ACK που λαμβάνεται για το ελλείπον τμήμα. Όταν φτάσει ένα ACK για το ελλείπον τμήμα, τότε εισέρχεται στην αποφυγή συμφόρησης αφού μειώσει το cwnd.  
Σε **λήξη χρόνου** τότε εισέρχεται στην **αργή εκκίνηση** αφού εκτελέσει τις ίδιες ενέργειες. Το cwnd τίθεται 1 και το ssthresh cwnd/2 πριν τη μοναδοποίηση του cwnd.

## Δικαιοσύνη 

Ένας μηχανισμός ελέγχου συμφόρησης λέγεται δίκαιος όταν ο μέσος ρυθμός μετάδοσης κάθε σύνδεση είναι περίπου R/K. δηλαδή λάθε σύνδεση παίρνει ένα **ίσο μερίδιο του εύρους ζώνης ζεύξης**.

**Στο UDP**, οι εφαρμογές μπορούν να στείλουν π.χ. ήχο μέσα στο δίκτυο με σταθερό ρυθμό και να χάσουν πακέτα αντί να μειώσουν τους ρυθμούς σε δίκαια επίπεδα σε περιόδους συμφόρησης.

**Πρόβλημα Δικαιοσύνσης στο TCP**

- Έστω ζεύξη με ρυθμό R
- Υποστήριξη client - server, με 9 εκτελούμενες εφαρμογές.
- Εισαγωγή νέας εφαρμογής με σύνδεση TCP - Ουτοπικά κάθε εφαρμογή έχει μερίδιο **R/10**.
  - Αν αυτή η σύνδεση χρησιμοποιεί 11 παράλληλες συνδέσεις TCP (πχ HTTP), τότε αυτή η εφαρμογή θα πάρει μεγαλύτερο (άδικο) μερίδιο, μεγαλύτερο από R/2.

### Εμφανής Ειδοποίηση Συμφόρησης (ECN): Έλεγχος Συμφόρησης Υποβοηθούμενος από το Δίκτυο.

Επιτρέπεται στο δίκτυο να σηματοδοτεί ρτά τη συμφόρηση σ'ένα αποστολέα και σε ένα παραλήπτη TCP. Αυτό λέγεται Εμφανής Ειδοποίηση Συμφόρησης. Εμπλέκονται τα πρωτόκολλα TCP & IP.  
Μια ρύθμιση των ECN bit χρησιμοποιείται από δρομολογητή για να δηλώσει ότι ο δρομολογητής έχει συμφόρηση. Αυτή η ένδειξη μεταφέρεται στο δεδομενόγραμμα, το οποίο ενημερώνει τον αποστολέα. **Η ένδειξη συνίσταται σε παραμένουσες συμφορήσεις** διότι ο ορισμός συμφόρησης δρομολογητή **παρέχεται μέσω παραμετροποίησης** από τον προμηθευτή του δρομολογητή και αποφασίζεται από τον χειριστή δικτύου.  
Το ECN επίσης χρησιμοποιείται από τον αποστολέα για να πληροφορήσει τους δρομολογητές ότι υπάρχουν δυνατότητες ECN μεταξύ αποστολέα - παραλήπτη.